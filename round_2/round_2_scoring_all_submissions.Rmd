---
title: "IDG-DREAM Round 2 Bayes Factor Analysis"
output:
  html_document:
    df_print: paged
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

Round 2 of the IDG-DREAM Challenge gave participants two opportunities to predict 394 Kd values between 25 compounds and 207 kinases. There are two subchallenges in this round that participants can win via: 

Sub-challenge 1: The top-performing teams will be selected based on the bootstrapped Spearman correlation of the predictions to the test dataset. Teams that have a Bayes Factor of less than 3 are tied. The tiebreaking metric to select the top performer will be the submission with the highest average AUC score.

Sub-challenge 2: The top-performing teams will be selected based on the bootstrapped RMSE of the predictions to the test dataset. Teams that have a Bayes Factor of less than 3 are tied. The tiebreaking metric to select the top performer will be the submission with the highest average AUC score.


In addition, participants/teams needed to submit a Dockerized model, writeup, and methods survey to qualified. Participants that could not fulfill this criteria were disqualified. 

In this analysis, we are not considering this last point - this is looking at all predictions whether they qualify to win or not. 


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(challengescoring)
library(reticulate)
library(tidyverse)
library(doMC)
doMC::registerDoMC(cores = detectCores()-1)

use_python("/usr/local/bin/python2")
synapse <- import("synapseclient")
syn <- synapse$Synapse()
synutils <- synapse$utils
syn$login()
source_python('https://raw.githubusercontent.com/Sage-Bionetworks/IDG-DREAM-Challenge-Analysis/master/round_1b/evaluation_metrics_python2.py?token=AE3WNSGZXHMQD6TMZJ7Q5US44V3AG')

spearman_py <- function(gold, pred){
  gold_py <- gold %>% np_array()
  pred_py <- pred %>% np_array()
  spearman(gold_py, pred_py)
}

rmse_py <- function(gold, pred){
  gold_py <- gold %>% np_array()
  pred_py <- pred %>% np_array()
  rmse(gold_py, pred_py)
}

fv <- syn$tableQuery("select id, submissionId AS objectId, teamId, userId from syn18513076")$filepath %>%
  read_csv()

leaderboard <- read_csv(syn$get("syn18520916")$path) %>% full_join(fv)

get_path <- function(id){
  syn$get(id)$path
}

gold <- read_csv(syn$get("syn18421225")$path)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_user_or_team_names <- function(id){
 name <- try(syn$getTeam(id)$name, silent = T) ##try to get the team name from id 
 if(class(name)=='try-error'){ ##if it is not a team, will return error, so then try to get user profile
 try({
   prof <- syn$getUserProfile(id = id) ##get first and last name
   fn <- prof$firstName
   ln <- prof$lastName
   if(is.null(fn) | is.null(ln)){
     un <- prof$userName
     return(un) 
   }else if(fn == "" | ln == ""){ ##if empty, get username instead
     un <- prof$userName
     return(un)
   }else{
     return(paste(fn, ln))
   }
   })
   }else{
     return(name)
   }
}

names<- sapply(unique(leaderboard$submitterId), get_user_or_team_names)
names(names) <- unique(leaderboard$submitterId)
names_df <- as.data.frame(names) %>% 
  magrittr::set_colnames("participant") %>% 
  rownames_to_column("submitterId") %>% 
  mutate(submitterId= as.numeric(submitterId)) %>% 
  mutate(participant = as.character(participant))

names_df$participant[names_df$participant=="瑞 张"] <- syn$getUserProfile(id = names_df$submitterId[names_df$participant=="瑞 张"])$userName

provided_docker <- c("9685944","9684548","9686292","9686206","9686189","9686280","9686228","9686257","9686233","9686275","9686290","9686276","9686325","9686312","9686327","9686281","9686304","9686230","9686285","9686279","9686322","9686330","9686326")
```

Here the first analysis shows all results, regardless of whether DQed or not. 

## PRELIMINARY RESULTS 

### SC1 - SPEARMAN (not official)

```{r echo=FALSE, message=FALSE, warning=FALSE}
####SPEARMAN ANALYSIS

best_spearman_by_team <- leaderboard %>%
  group_by(submitterId) %>%
  top_n(1, spearman) %>%
  ungroup() %>%
  arrange(-spearman)

paths <- map_chr(best_spearman_by_team$id, get_path)

best_path <- paths[1]
other_paths <- paths[-1]

results_spearman <- finalScoring(predictions = other_paths,
             predictionColname = 'pKd_[M]_pred',
             predictionIds = best_spearman_by_team$objectId[-1],
             goldStandard = gold,
             goldStandardColname = 'pKd_[M]',
             bestPrediction = best_path,
             bestPredictionId = best_spearman_by_team$objectId[1],
             keyColumns = colnames(gold)[1:6],
             doParallel = TRUE,
             scoreFun = spearman_py)

tidy_bayes <- tibble('objectId' = colnames(results_spearman$bootstrappedScores),
                         'bayes' = results_spearman$bayes)

tidy_res <- results_spearman$bootstrappedScores %>%
  as.data.frame %>%
  tidyr::gather(objectId, bootstrappedScore) %>%
  left_join(tidy_bayes) %>%
  left_join(leaderboard %>% mutate(objectId = as.character(objectId))) %>% 
  left_join(names_df)


ggplot(data = tidy_res) +
  geom_boxplot(aes(x = reorder(participant, bootstrappedScore, fun = median), y = bootstrappedScore,
                   color = cut(bayes, c(-Inf, 3, 5,Inf))), outlier.shape = NA)+
  coord_flip() +
  scale_color_manual(values = c("#30C31E","#FFCA3E","#FF3E3E"),
                     name = "Bayes Factor",
                     labels = c("<3","3-5",">5")) +
  labs(x = "Submission", y = "Bootstrapped Spearman") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))

ggplot(data = tidy_res) +
  geom_boxplot(aes(x = reorder(participant, bootstrappedScore, fun = median), y = bootstrappedScore), outlier.shape = NA)+
  coord_flip() +
  labs(x = "Submission", y = "Bootstrapped Spearman") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))

```

### SC2 - RMSE (not official)

```{r echo=FALSE, message=FALSE, warning=FALSE}

####RMSE ANALYSIS

best_rmse_by_team <- leaderboard %>%
  group_by(submitterId) %>%
  top_n(1, -rmse) %>%
  ungroup() %>%
  arrange(rmse)

paths <- map_chr(best_rmse_by_team$id, get_path)

best_path <- paths[1]
other_paths <- paths[-1]

results_rmse <- finalScoring(predictions = other_paths,
                        predictionColname = 'pKd_[M]_pred',
                        predictionIds = best_rmse_by_team$objectId[-1],
                        goldStandard = gold,
                        goldStandardColname = 'pKd_[M]',
                        bestPrediction = best_path,
                        bestPredictionId = best_rmse_by_team$objectId[1],
                        keyColumns = colnames(gold)[1:6],
                        doParallel = TRUE,
                        scoreFun = rmse_py,
                        largerIsBetter = F)

tidy_bayes <- tibble('objectId' = colnames(results_rmse$bootstrappedScores),
                     'bayes' = results_rmse$bayes)

tidy_res_rmse <- results_rmse$bootstrappedScores %>%
  as.data.frame %>%
  tidyr::gather(objectId, bootstrappedScore) %>%
  left_join(tidy_bayes) %>%
  left_join(leaderboard %>% mutate(objectId = as.character(objectId))) %>% 
  left_join(names_df)

ggplot(data = tidy_res_rmse) +
  geom_boxplot(aes(x = reorder(participant, -bootstrappedScore, fun = median), y = log10(bootstrappedScore),
                   color = cut(bayes, c(-Inf, 3, 5, 20, Inf))), outlier.shape = NA)+
  coord_flip() +
  scale_color_manual(values = c("#30C31E","#FFCA3E","#FF3E3E",'#000000'),
                     name = "Bayes Factor",
                     labels = c("<3","3-5",">5")) +
  labs(x = "Submission", y = "log10(Bootstrapped RMSE)") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))

ggplot(data = tidy_res_rmse) +
  geom_boxplot(aes(x = reorder(participant, -bootstrappedScore, fun = median), y = log10(bootstrappedScore)), outlier.shape = NA)+
  coord_flip() +
  labs(x = "Submission", y = "log10(Bootstrapped RMSE)") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))

```

```{r}
sessionInfo()
```

# galton ensemble
```{r echo=FALSE, message=FALSE, warning=FALSE}

foo_spearman <- c()
foo_rmse <- c()

for(i in 1:54){
  
best_spearman_by_team <- leaderboard %>%
  group_by(submitterId) %>%
  top_n(1, spearman) %>%
  ungroup() %>%
  arrange(-spearman) %>% 
  slice(1:i)

paths <- map_chr(best_spearman_by_team$id, get_path)
names(paths) <- best_spearman_by_team$objectId

preds_galton <- pmap(.l = list(path = paths, renameColname = 'pKd_[M]_pred', newName = names(paths)), .f = challengescoring:::.read_and_rename) %>% purrr::reduce(left_join) %>% tidyr::gather(objectId, pred, -Compound_SMILES, -Compound_InchiKeys, -Compound_Name, -UniProt_Id, -Entrez_Gene_Symbol, -DiscoveRx_Gene_Symbol) %>% filter(pred<100) %>%  group_by(Compound_SMILES, Compound_InchiKeys, Compound_Name, UniProt_Id, Entrez_Gene_Symbol, DiscoveRx_Gene_Symbol) %>% summarize(galton_ensemble = mean(pred)) %>% full_join(gold)

foo_spearman <- c(foo_spearman, spearman_py(preds_galton$`pKd_[M]`, preds_galton$galton_ensemble))
foo_rmse <- c(foo_rmse, rmse_py(preds_galton$`pKd_[M]`, preds_galton$galton_ensemble))
}

ensembles <- tibble(iter=c(1:54), spearman=foo_spearman, rmse=foo_rmse)



ggplot(data = tidy_res) +
  geom_boxplot(aes(x = reorder(participant, bootstrappedScore, fun = median), y = bootstrappedScore,
                   color = cut(bayes, c(-Inf, 3, 5,Inf))), outlier.shape = NA)+
  coord_flip() +
  scale_color_manual(values = c("#30C31E","#FFCA3E","#FF3E3E"),
                     name = "Bayes Factor",
                     labels = c("<3","3-5",">5")) +
  labs(x = "Submission", y = "Bootstrapped Spearman") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))

ggplot(data = tidy_res) +
  geom_boxplot(aes(x = reorder(participant, bootstrappedScore, fun = median), y = bootstrappedScore), outlier.shape = NA)+
  coord_flip() +
  labs(x = "Submission", y = "Bootstrapped Spearman") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))

```
